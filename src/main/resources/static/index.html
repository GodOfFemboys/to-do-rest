<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">
<div id="app" class="container py-5">
    <div class="text-center mb-4">
        <h1 class="fw-bold">üìã Task Manager</h1>
    </div>

    <!-- Login/Register -->
    <div v-if="!token">
        <div class="row">
            <div class="col-md-6">
                <h3>üîê –í—Ö–æ–¥</h3>
                <form @submit.prevent="login">
                    <div class="mb-3">
                        <label class="form-label">–ò–º—è</label>
                        <input v-model="loginForm.name" type="text" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                        <input v-model="loginForm.password" type="password" class="form-control" required>
                    </div>
                    <div class="text-danger mb-2" v-if="loginError">{{ loginError }}</div>
                    <button class="btn btn-primary w-100">–í–æ–π—Ç–∏</button>
                </form>
            </div>

            <div class="col-md-6">
                <h3>üÜï –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
                <form @submit.prevent="register">
                    <div class="mb-3">
                        <label class="form-label">–ò–º—è</label>
                        <input v-model="registerForm.name" type="text" class="form-control" required>
                        <div class="text-danger" v-if="registerErrors.name">{{ registerErrors.name }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                        <input v-model="registerForm.password" type="password" class="form-control" required>
                        <div class="text-danger" v-if="registerErrors.password">{{ registerErrors.password }}</div>
                    </div>
                    <button class="btn btn-success w-100">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Tasks -->
    <div v-else>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>–í–∞—à–∏ –∑–∞–¥–∞—á–∏</h3>
            <div>
                <span class="me-3">–ü—Ä–∏–≤–µ—Ç, <strong>{{ username }}</strong></span>
                <button class="btn btn-outline-danger" @click="logout">–í—ã–π—Ç–∏</button>
            </div>
        </div>

        <input v-model="searchQuery" type="text" class="form-control mb-3" placeholder="–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á...">

        <form class="row g-2 mb-4" @submit.prevent="addTask">
            <div class="col-8">
                <input v-model="newTask.description" type="text" class="form-control" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞" required>
            </div>
            <div class="col-4">
                <button class="btn btn-primary w-100">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </form>

        <div v-if="filteredTasks.length === 0" class="text-muted">–ù–µ—Ç –∑–∞–¥–∞—á</div>
        <ul class="list-group">
            <li v-for="task in filteredTasks" :key="task.id" class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <input type="checkbox" v-model="task.completed" @change="toggleTask(task)" class="form-check-input me-2">
                    <span :class="{ 'text-decoration-line-through': task.completed }">{{ task.description }}</span>
                </div>
                <button class="btn btn-sm btn-danger" @click="deleteTask(task.id)">–£–¥–∞–ª–∏—Ç—å</button>
            </li>
        </ul>
    </div>
</div>

<script>
    const api = axios.create({
        baseURL: 'http://localhost:8080/api',
    });

    const app = Vue.createApp({
        data() {
            return {
                token: localStorage.getItem('token'),
                loginForm: { name: '', password: '' },
                registerForm: { name: '', password: '' },
                loginError: '',
                registerErrors: {},
                tasks: [],
                newTask: { description: '', completed: false },
                searchQuery: ''
            }
        },
        computed: {
            username() {
                if (!this.token) return '';
                try {
                    const base64 = this.token.split(' ')[1]; // –ø–æ—Å–ª–µ "Basic "
                    const decoded = atob(base64);
                    return decoded.split(':')[0];
                } catch {
                    return '';
                }
            },
            filteredTasks() {
                if (!this.searchQuery) return this.tasks;
                const query = this.searchQuery.toLowerCase();
                return this.tasks.filter(task => task.description.toLowerCase().includes(query));
            }
        },
        methods: {
            async login() {
                try {
                    const headers = {
                        Authorization: 'Basic ' + btoa(`${this.loginForm.name}:${this.loginForm.password}`)
                    };
                    const res = await api.get('/tasks', { headers });
                    this.token = headers.Authorization;
                    localStorage.setItem('token', this.token);
                    this.fetchTasks();
                    this.loginError = '';
                } catch (err) {
                    this.loginError = '–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                }
            },
            async register() {
                this.registerErrors = {};
                const { name, password } = this.registerForm;
                if (name.length < 3 || name.length > 20) {
                    this.registerErrors.name = '–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 3 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤';
                }
                if (password.length < 6 || password.length > 100) {
                    this.registerErrors.password = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 6 –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤';
                }
                if (Object.keys(this.registerErrors).length) return;

                try {
                    await api.post('/auth/register', { name, password });
                    this.loginForm = { ...this.registerForm };
                    this.registerForm = { name: '', password: '' };
                    this.registerErrors = {};
                    this.login(); // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥
                } catch (err) {
                    this.registerErrors.name = '–ò–º—è –∑–∞–Ω—è—Ç–æ –∏–ª–∏ –æ—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
                }
            },
            logout() {
                localStorage.removeItem('token');
                this.token = null;
                this.tasks = [];
                this.searchQuery = '';
            },
            async fetchTasks() {
                const res = await api.get('/tasks', {
                    headers: { Authorization: this.token }
                });
                this.tasks = res.data;
            },
            async addTask() {
                if (!this.newTask.description.trim()) return;
                const res = await api.post('/tasks', this.newTask, {
                    headers: { Authorization: this.token }
                });
                this.tasks.push(res.data);
                this.newTask.description = '';
            },
            async deleteTask(id) {
                await api.delete(`/tasks/${id}`, {
                    headers: { Authorization: this.token }
                });
                this.tasks = this.tasks.filter(t => t.id !== id);
            },
            async toggleTask(task) {
                await api.patch(`/tasks/${task.id}`, {
                    description: task.description,
                    completed: task.completed
                }, {
                    headers: { Authorization: this.token }
                });
            }
        },
        mounted() {
            if (this.token) this.fetchTasks();
        }
    });

    app.mount('#app');
</script>
</body>
</html>
